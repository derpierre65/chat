$(function(){var e=localStorage.getItem("chatUsername")?localStorage.getItem("chatUsername"):"",t="",n=!0,i=null,o={},r=["Bitte benutze /nick <Name>.","Bitte benutze einen neuen Namen","Der Name ist bereits vergeben."];for($(window).focus(function(){n=!0}).blur(function(){n=!1});!e.length;)null==(e=prompt("Name"))&&(e=""),e=e.trim();function c(){var e="";console.log(o),Object.keys(o).forEach(function(t){e+="<li>"+o[t]+"</li>"}),$("#users-online").html($("<ul>").html(e))}localStorage.setItem("chatUsername",e);var a=io(document.location.host+":3666",{secure:!0,query:"username="+e});function l(t){var i=t.time?new Date(t.time):new Date,o=("0"+i.getHours()).slice(-2),r=("0"+i.getMinutes()).slice(-2),c=("0"+i.getSeconds()).slice(-2),a="",l="";t.color&&(a='<span style="color:'+t.color+'">',l="</span>"),$("#content").append(`[${o}:${r}:${c}] `+a+(t.name?"&lt;"+t.name.htmlentities()+"&gt; ":"")+t.text.htmlentities()+l+"<br />");var s=document.getElementById("content");if(s.scrollTop=s.scrollHeight,t.name&&t.name!==e&&!n)new Notification("Nachricht von "+t.name,{body:t.text})}function s(e){var t="offline",n="online",i="Online";e||(t="online",n="offline",i="Offline"),$("#status").removeClass(t).addClass(n).html(i)}Notification.requestPermission(),String.prototype.htmlentities=function(){var e=this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");return(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=e.replace(/\[b\](.+?)\[\/b\]/g,"<strong>$1</strong>")).replace(/\[s\](.+?)\[\/s\]/g,"<s>$1</s>")).replace(/\[url\](.+?)\[\/url\]/g,'<a target="_blank" href="$1">$1</a>')).replace(/\[url=(.+?)\](.+?)\[\/url\]/g,'<a target="_blank" href="$1">$2</a>')).replace(/\[u\](.+?)\[\/u\]/g,"<u>$1</u>")).replace(/\[i\](.+?)\[\/i\]/g,"<i>$1</i>")).replace(/\[twitch-clip\](.+?)\[\/twitch-clip\]/g,'<br/><iframe src="https://clips.twitch.tv/embed?clip=$1&autoplay=false&tt_medium=clips_embed" width="640" height="360" frameborder="0" scrolling="no" allowfullscreen="true"></iframe>')).replace(/\[twitch-video\](.+?)\[\/twitch-video\]/g,'<br/><iframe src="https://player.twitch.tv/?autoplay=false&video=v$1" frameborder="0" allowfullscreen="true" scrolling="no" height="378" width="640"></iframe>')).replace(/\[youtube\](.+?)\[\/youtube\]/g,'<br/><iframe width="640" height="360" src="https://www.youtube.com/embed/$1?rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>')).replace(/\[spotify\](.+?)\[\/spotify\]/g,'<br/><iframe src="https://open.spotify.com/embed/$1" width="300" height="380" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>')).replace(/\[img\](.+?)\[\/img\]/g,'<br/><img src="$1" style="max-width: 300px;" />')).replace(/\[video=(.+?)\](.+?)\[\/video\]/g,'<br/><video style="max-width: 300px;" controls><source src="$2" type="video/$1"></video>')).replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1<br />$2")},a.on("connect",function(){s(!0)}).on("messages",function(e,t){o=t,$("#content").html(""),e.forEach(function(e){l(e)})}).on("disconnectUser",function(t){o[t]!==e&&l({text:"[b]"+o[t]+"[/b] hat den Chat verlassen."}),delete o[t],c()}).on("newUser",function(n,i){o[n]=i,i!==e?l({text:"[b]"+i+"[/b] hat den Chat betreten."}):t=n,c()}).on("cmderror",function(e){l({text:r[e],color:"red"})}).on("changedName",function(n,i){n===t&&(e=i,localStorage.setItem("chatUsername",e)),l({text:"[b]"+o[n]+"[/b] hat sein Namen in [b]"+i+"[/b] geändert."}),o[n]=i,c()}).on("disconnect",function(){s(!1)}).on("chat",function(e,t){l({name:e,text:t})});function u(e,t){if(0===t)encType=e.substr(e.length-3),(encType="ebm")&&(encTypetemp=e.substr(e.length-4),(encTypetemp=".webm")&&(encType="webm"));else if(1===t)encType="mp4";else if(2===t)encType="ogg";else{if(3===t){var n=e.indexOf("twitch.tv/");if(n>=0){if(e.indexOf("twitch.tv/videos/"))return"[twitch-video]"+(e=e.substr(n+"twitch.tv/videos/".length))+"[/twitch-video]";e=e.substr(n+"twitch.tv/".length)}return"[twitch-clip]"+e+"[/twitch-clip]"}if(4===t){var i=e.indexOf("youtube.com/");return i>=0&&(e=e.substr(i+"youtube.com/".length)),"[youtube]"+(r=e,null==(c=new RegExp("[?&]"+"v"+"=([^&#]*)").exec(r))?null:decodeURI(c[1])||0)+"[/youtube]"}if(5===t){var o=e.indexOf("open.spotify.com/");return o>=0&&(e=e.substr(o+"open.spotify.com/".length)),"[spotify]"+e+"[/spotify]"}}var r,c;return"[video="+encType+"]"+e+"[/video]"}function m(e,t){return t.indexOf(e)>=0}$(".bb-button").on("click",function(){var e=$(this).attr("id").substr(3),t=$("<dl />"),n=function(e){if(Array.isArray(e))$.each(e,function(){n(this)});else{var i=null;switch(e.type){case"text":i=$("<input />",{type:"text",id:"bbcode-input-"+e.name}).addClass("form-control");break;case"select":i=$("<select />",{id:"bbcode-input-"+e.name}),$.each(e.options,function(e){i.append($("<option />").val(e).html(this))})}t.append($("<dt />").html(e.title)),t.append($("<dd />").append(i))}};!function(e){switch(e){case"italic":case"under":case"crossed":case"bold":n({title:"Text",name:"text",type:"text"});var t="b";switch(e){case"italic":t="i";break;case"crossed":t="s";break;case"under":t="u"}i=function(){return"["+t+"]"+$("#bbcode-input-text").val()+"[/"+t+"]"};break;case"img":n({title:"Link des Bildes",name:"imageurl",type:"text"}),i=function(){var e=$("#bbcode-input-imageurl").val();return!!e.length&&"[img]"+e+"[/img]"};break;case"url":n({title:"Anzeigetext (optional)",name:"showtext",type:"text"}),n({title:"Link",name:"link",type:"text"}),i=function(){var e=$("#bbcode-input-showtext").val().trim(),t=$("#bbcode-input-link").val().trim(),n="",i=t.substr(t.length-4),o=m(i,["webm",".mp4",".ogg"]);return!!t.length&&(o||m("twitch.tv/",t)||m("youtube.com/",t)||m("open.spotify.com/",t)?(n=t.indexOf("twitch.tv/")>=0?3:t.indexOf("youtube.com/")>=0?4:m("open.spotify.com/",t)?5:0,u(t,n)):e.length?"[url="+t+"]"+e+"[/url]":"[url]"+t+"[/url]")};break;case"video":n({title:"Typ (optional)",name:"type",type:"select",options:{0:"Automatisch",1:"MP 4",2:"OGG",3:"Twitch Clip",4:"YouTube"}}),n({title:"Link",name:"link",type:"text"}),i=function(){var e=$("#bbcode-input-link").val().trim(),t=parseInt($("#bbcode-input-type").val());return!!e.length&&(0===t&&e.indexOf("twitch.tv/")>=0&&(t=3),0===t&&e.indexOf("youtube.com/")>=0&&(t=4),m("open.spotify.com/",e)&&(t=5),u(e,t))}}}(e),$(".modal-title").html(e),$(".modal-body").html(t),$(".modal").modal()}),$(".btn-paste").on("click",function(){var e=i();!1!==e&&($(".modal").modal("hide"),function(e,t){var n=document.getElementById(e);if(n){var i=n.scrollTop,o=0,r=n.selectionStart||"0"==n.selectionStart?"ff":!!document.selection&&"ie";if("ie"==r){n.focus();var c=document.selection.createRange();c.moveStart("character",-n.value.length),o=c.text.length}else"ff"==r&&(o=n.selectionStart);var a=n.value.substring(0,o),l=n.value.substring(o,n.value.length);if(n.value=a+t+l,o+=t.length,"ie"==r){n.focus();var s=document.selection.createRange();s.moveStart("character",-n.value.length),s.moveStart("character",o),s.moveEnd("character",0),s.select()}else"ff"==r&&(n.selectionStart=o,n.selectionEnd=o,n.focus());n.scrollTop=i}else console.log("fail")}("box",e))}),$("#box").on("keydown",function(e){e.ctrlKey||e.shiftKey||13!==e.keyCode||e.preventDefault()}).on("keyup",function(t){var n=$("#box"),i=n.val().trim();if(n.focus(),!i.length||!e.length)return!1;if(!t.ctrlKey&&!t.shiftKey&&13===t.keyCode){if("/help"===i.toLowerCase())return void l({text:"/nick [Name] - änderte den Nicknamen."});a.emit("chat",i),n.val("")}})});